---
title: "Linux kernel exploitation lab setup"
---

## tools needed

```
qemu-x86-64
gcc
g++
make
cmake #and much more tools...
```

## You will need Linux kernel and busy-box utility

```

curl -LO https://busybox.net/downloads/busybox-1.36.1.tar.bz2

curl -LO https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.38.tar.xz

```

## Next you need to compile Linux kernel

```

tar xf linux-6.6.38.tar.xz 

cd linux-6.6.38

#make default 
make x86_64_defconfig

#build kernel image
make -j$(nproc) bzImage


```


### building busy box

#### but i would recommend you'll to pull pre-build image of busy box x86_64 because in some case building busy box creates some errors.


## Next we need to build file-system

```

mkdir rootfs

cd rootfs

#make needed files and dir

mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,usr/bin,usr/sbin}

#copy busybox file to rootfs/bin

cp busybox rootfs/bin/

#make symbolic links to busybox

ln -s ./busybox ls
ln -s ./busybox id
ln -s ./busybox pwd
ln -s ./busybox mkdir
ln -s ./busybox insmod
ln -s ./busybox rmmod
ln -s ./busybox time
ln -s ./busybox date
ln -s ./busybox kill
ln -s ./busybox exit

#add init file to startup
touch init

```

### init file

```
#!/bin/sh
set -e

echo "[!] Welcome to minimal linux kernel"
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev 2>/dev/null || true

# optional: simple device population if you use mdev
# echo /sbin/mdev > /proc/sys/kernel/hotplug
# /sbin/mdev -s

# install all busybox applets as symlinks into common dirs
/bin/busybox --install -s /bin
/bin/busybox --install -s /sbin
/bin/busybox --install -s /usr/bin
/bin/busybox --install -s /usr/sbin

echo "[!] Happy Pwning"

# hand a controlling TTY to the shell
#exec /bin/cttyhack /bin/sh
#exec setsid /bin/sh < /dev/console > /dev/console 2>&1
exec setsid cttyhack sh

```

```
chmod +x init
```



### Then we need to build initramfs image

```
find . | cpio -H newc -o | gzip -9 > ../initramfs.cpio.gz

```

- `find .` → list all files in the initramfs root directory.
    
- `cpio -H newc -o` → pack them into a **newc cpio archive**.
    
- `gzip -9` → compress the archive.
    
- `> ../initramfs.cpio.gz` → save it as a file.
    

##### The result is a **compressed initramfs image** that the Linux kernel can use at boot.



### now we are good to go 
#### below is the qemu command to run minimal Linux kernel for pwning 

```
 qemu-system-x86_64 \
  -kernel bzImage \
  -initrd initramfs.cpio.gz \
  -append "console=ttyS0,115200 clocksource=hpet tsc=reliable loglevel=3 quiet rdinit=/init" \
  -nographic

```

### this way we can boot it up

```
 qemu-system-x86_64 \
  -kernel bzImage \
  -initrd initramfs.cpio.gz \
  -append "console=ttyS0,115200 clocksource=hpet tsc=reliable loglevel=3 quiet rdinit=/init" \
  -nographic -s -S

```

### the -s and -S is used to connect to gdb localhost : 1234 so we can start debugging our kernel

